<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Method Signature Quiz</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }
        .layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar-header {
            padding: 1.5rem;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .nav-list {
            padding: 1rem 0;
        }
        .nav-item {
            padding: 0.75rem 1.5rem;
            margin: 0.25rem 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }
        .nav-item.active {
            background: rgba(255,255,255,0.2);
            font-weight: 600;
        }
        .nav-item.completed {
            background: rgba(76, 175, 80, 0.3);
        }
        .nav-item.completed.active {
            background: rgba(76, 175, 80, 0.4);
        }
        .nav-item .badge {
            margin-left: auto;
        }
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem;
        }
        .quiz-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .method-signature {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            margin: 1.5rem 0;
        }
        select.form-select {
            display: inline-block;
            width: auto;
            min-width: 100px;
            font-family: 'Courier New', monospace;
            margin: 0 0.25rem;
        }
        select.is-valid {
            border-color: #198754;
            background-color: #d1e7dd;
        }
        select.is-invalid {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            min-height: 2500px;
        }
        .code-editor:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-check-code {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-check-code:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a4093 100%);
            color: white;
        }
        .score-badge {
            font-size: 1.5rem;
            padding: 0.75rem 1.5rem;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="bi bi-code-square"></i> Array Methods Practice</h2>
                <small class="text-white-50">Java Programming Practice</small>
            </div>
            <div class="nav-list" id="nav-items"></div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Progress Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="mb-0">Writing Array Methods</h1>
                        <p class="text-muted mb-0" id="progress"></p>
                        <br />
                        <p>Work through these array problems. You need to complete the signature first and then write the code. You will be
                            given feedback after each code attempt. You *may* do problems out of order and skip problems. The harder problems
                            are near the end so feel free to select problems best suited to you.
                        </p>
                    </div>
                    <span class="badge bg-success score-badge" id="score-display">0/19</span>
                </div>

                <!-- Quiz Content Card -->
                <div class="quiz-card" id="quiz-content"></div>
            </div>
        </main>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const questions = [
            {
                description: "Method <code>findMax</code> takes two integers and returns the larger of the two.",
                signature: "public static ___RETURN___ findMax(___PARAM1___ a, ___PARAM2___ b)",
                answers: { RETURN: "int", PARAM1: "int", PARAM2: "int" },
                codeTemplate: "public static int findMax(int a, int b) {\n    // Your code here\n    \n}",
                shortName: "findMax"
            },
            {
                description: "Method <code>sumArray</code> takes an integer array and returns the sum of all elements as an integer.",
                signature: "public static ___RETURN___ sumArray(___PARAM1___ a)",
                answers: { RETURN: "int", PARAM1: "int[]" },
                codeTemplate: "public static int sumArray(int[] a) {\n    // Your code here\n    \n}",
                shortName: "sumArray"
            },
            {
                description: "Method <code>average</code> takes an integer array and returns the average of its elements as a double.",
                signature: "public static ___RETURN___ average(___PARAM1___ arr)",
                answers: { RETURN: "double", PARAM1: "int[]" },
                codeTemplate: "public static double average(int[] arr) {\n    // Your code here\n    \n}",
                shortName: "average"
            },
            {
                description: "Method <code>isAllPositive</code> takes an integer array and returns true if all numbers are positive, false otherwise.",
                signature: "public static ___RETURN___ isAllPositive(___PARAM1___ a)",
                answers: { RETURN: "boolean", PARAM1: "int[]" },
                codeTemplate: "public static boolean isAllPositive(int[] a) {\n    // Your code here\n    \n}",
                shortName: "isAllPositive"
            },
            {
                description: "Method <code>makeCopy</code> takes an integer array and returns a new array containing the same values.",
                signature: "public static ___RETURN___ makeCopy(___PARAM1___ original)",
                answers: { RETURN: "int[]", PARAM1: "int[]" },
                codeTemplate: "public static int[] makeCopy(int[] original) {\n    // Your code here\n    \n}",
                shortName: "makeCopy"
            },
            {
                description: "Method <code>repeat</code> takes a String and an integer n, and returns a new String with the original repeated n times.",
                signature: "public static ___RETURN___ repeat(___PARAM1___ s, ___PARAM2___ n)",
                answers: { RETURN: "String", PARAM1: "String", PARAM2: "int" },
                codeTemplate: "public static String repeat(String s, int n) {\n    // Your code here\n    \n}",
                shortName: "repeat"
            },
            {
                description: "Method <code>hasValue</code> takes an integer array and an integer target, and returns true if target appears in the array, false otherwise.",
                signature: "public static ___RETURN___ hasValue(___PARAM1___ arr, ___PARAM2___ target)",
                answers: { RETURN: "boolean", PARAM1: "int[]", PARAM2: "int" },
                codeTemplate: "public static boolean hasValue(int[] arr, int target) {\n    // Your code here\n    \n}",
                shortName: "hasValue"
            },
            {
                description: "Method <code>fillArray</code> takes an integer array and an integer value, and fills every position in the array with that value. It does not return anything.",
                signature: "public static ___RETURN___ fillArray(___PARAM1___ arr, ___PARAM2___ value)",
                answers: { RETURN: "void", PARAM1: "int[]", PARAM2: "int" },
                codeTemplate: "public static void fillArray(int[] arr, int value) {\n    // Your code here\n    \n}",
                shortName: "fillArray"
            },
            {
                description: "Method <code>swap</code> swaps the elements at positions i and j in array arr (modifies the original array).",
                signature: "public static ___RETURN___ swap(___PARAM1___ arr, ___PARAM2___ i, ___PARAM3___ j)",
                answers: { RETURN: "void", PARAM1: "int[]", PARAM2: "int", PARAM3: "int" },
                codeTemplate: "public static void swap(int[] arr, int i, int j) {\n    // Your code here\n    \n}",
                shortName: "swap"
            },
            {
                description: "Method <code>findMinMax</code> returns an array containing two values: the minimum and maximum elements from the input array.",
                signature: "public static ___RETURN___ findMinMax(___PARAM1___ arr)",
                answers: { RETURN: "int[]", PARAM1: "int[]" },
                codeTemplate: "public static int[] findMinMax(int[] arr) {\n    // Your code here\n    \n}",
                shortName: "findMinMax"
            },
            {
                description: "Method <code>arraysEqual</code> checks if two arrays contain the same elements in the same order.",
                signature: "public static ___RETURN___ arraysEqual(___PARAM1___ a, ___PARAM2___ b)",
                answers: { RETURN: "boolean", PARAM1: "int[]", PARAM2: "int[]" },
                codeTemplate: "public static boolean arraysEqual(int[] a, int[] b) {\n    // Your code here\n    \n}",
                shortName: "arraysEqual"
            },
            {
                description: "Method <code>removeNegatives</code> takes an integer array and returns a new array containing only the non-negative values from the original array.",
                signature: "public static ___RETURN___ removeNegatives(___PARAM1___ arr)",
                answers: { RETURN: "int[]", PARAM1: "int[]" },
                codeTemplate: "public static int[] removeNegatives(int[] arr) {\n    // Your code here\n    \n}",
                shortName: "removeNegatives"
            },
            {
                description: "Method <code>printBackwards</code> takes a String and prints it in reverse order. It does not return anything.",
                signature: "public static ___RETURN___ printBackwards(___PARAM1___ s)",
                answers: { RETURN: "void", PARAM1: "String" },
                codeTemplate: "public static void printBackwards(String s) {\n    // Your code here\n    \n}",
                shortName: "printBackwards"
            },
            {
                description: "Method <code>combineArrays</code> takes two integer arrays and returns a new array containing all elements from the first array followed by all elements from the second array.",
                signature: "public static ___RETURN___ combineArrays(___PARAM1___ a, ___PARAM2___ b)",
                answers: { RETURN: "int[]", PARAM1: "int[]", PARAM2: "int[]" },
                codeTemplate: "public static int[] combineArrays(int[] a, int[] b) {\n    // Your code here\n    \n}",
                shortName: "combineArrays"
            },
            {
                description: "Method <code>reverseInPlace</code> reverses the elements of an array (modifying the original array).",
                signature: "public static ___RETURN___ reverseInPlace(___PARAM1___ arr)",
                answers: { RETURN: "void", PARAM1: "int[]" },
                codeTemplate: "public static void reverseInPlace(int[] arr) {\n    // Your code here\n    \n}",
                shortName: "reverseInPlace"
            },
            {
                description: "Method <code>rotateLeft</code> shifts all elements in an array left by n positions, wrapping around (modifies the original array).",
                signature: "public static ___RETURN___ rotateLeft(___PARAM1___ arr, ___PARAM2___ n)",
                answers: { RETURN: "void", PARAM1: "int[]", PARAM2: "int" },
                codeTemplate: "public static void rotateLeft(int[] arr, int n) {\n    // Your code here\n    \n}",
                shortName: "rotateLeft"
            },
        ];

        const typeOptions = ["", "void", "int", "double", "boolean", "String", "int[]", "double[]", "String[]"];

        let currentQuestion = 0;
        let score = 0;
        let signature_attempts = 0;
        let completedQuestions = new Set();

        function updateScoreDisplay() {
            document.getElementById('score-display').textContent = score + '/' + questions.length;
        }

        function createNavbar() {
            const navItems = document.getElementById('nav-items');
            navItems.innerHTML = '';

            questions.forEach(function(q, index) {
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';

                const number = document.createElement('span');
                number.className = 'badge bg-light text-dark';
                number.textContent = index + 1;
                navItem.appendChild(number);

                const name = document.createElement('span');
                name.textContent = q.shortName;
                navItem.appendChild(name);

                if (index === currentQuestion) {
                    navItem.classList.add('active');
                }
                if (completedQuestions.has(index)) {
                    navItem.classList.add('completed');
                    const check = document.createElement('i');
                    check.className = 'bi bi-check-circle-fill ms-auto';
                    navItem.appendChild(check);
                }

                navItem.onclick = function() {
                    goToQuestion(index);
                };
                navItems.appendChild(navItem);
            });
        }

        function goToQuestion(index) {
            currentQuestion = index;
            displayQuestion();
            createNavbar();
        }

        function createDropdown(id, options) {
            const select = document.createElement('select');
            select.className = 'form-select';
            select.id = id;
            options.forEach(function(opt) {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
            select.addEventListener('change', function() {
                const feedback = document.getElementById('feedback');
                if (feedback) {
                    feedback.style.display = 'none';
                }
                const sigContainer = document.getElementById('signature-container');
                if (sigContainer) {
                    const selects = sigContainer.querySelectorAll('select');
                    selects.forEach(function(s) {
                        s.classList.remove('is-valid', 'is-invalid');
                    });
                }
            });
            return select;
        }

        function setupTabIndent(textarea) {
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    const value = this.value;
                    const indent = '    ';

                    if (e.shiftKey) {
                        const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                        const lineBeforeCursor = value.substring(lineStart, start);
                        if (lineBeforeCursor.startsWith(indent)) {
                            this.value = value.substring(0, lineStart) + value.substring(lineStart + indent.length);
                            this.selectionStart = this.selectionEnd = start - indent.length;
                        }
                    } else {
                        this.value = value.substring(0, start) + indent + value.substring(end);
                        this.selectionStart = this.selectionEnd = start + indent.length;
                    }
                }
            });
        }

        function displayQuestion() {
            signature_attempts = 0;
            const question = questions[currentQuestion];
            const content = document.getElementById('quiz-content');
            const progress = document.getElementById('progress');

            progress.textContent = 'Question ' + (currentQuestion + 1) + ' of ' + questions.length;

            let html = '<div class="alert alert-primary" role="alert">' + question.description + '</div>' +
                '<div class="method-signature" id="signature-container"></div>' +
                '<div class="mb-3">' +
                    '<button class="btn btn-success me-2" onclick="checkAnswer()"><i class="bi bi-check-circle"></i> Check Signature</button>' +
                    '<button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" disabled><i class="bi bi-arrow-right"></i> Next Question</button>' +
                '</div>' +
                '<div id="feedback"></div>';

            if (question.codeTemplate) {
                html += '<div id="code-section" style="display:none;" class="mt-4">' +
                    '<h5><i class="bi bi-code-slash"></i> Write Your Code:</h5>' +
                    '<textarea class="form-control code-editor" id="code-input" rows=10>'  + '</textarea>' +
                    '<button class="btn btn-check-code mt-3" onclick="checkCode()"><i class="bi bi-play-circle"></i> Check My Code</button>' +
                    '<span class="ms-3 text-muted" id="loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Checking...</span>' +
                    '<div class="mt-3" id="code-feedback"></div>' +
                '</div>';
            }

            content.innerHTML = html;

            const codeSection = document.getElementById('code-section');
            if (codeSection) {
                const observer = new MutationObserver(function() {
                    const codeTextarea = document.getElementById('code-input');
                    if (codeTextarea && codeSection.style.display !== 'none') {
                        setupTabIndent(codeTextarea);
                        observer.disconnect();
                    }
                });
                observer.observe(codeSection, { attributes: true, attributeFilter: ['style'] });
            }

            const sigContainer = document.getElementById('signature-container');
            const parts = question.signature.split(/(___\w+___)/);

            parts.forEach(function(part) {
                if (part.startsWith('___') && part.endsWith('___')) {
                    const dropdownId = part.slice(3, -3);
                    const dropdown = createDropdown(dropdownId, typeOptions);
                    sigContainer.appendChild(dropdown);
                } else {
                    sigContainer.appendChild(document.createTextNode(part));
                }
            });
        }

        function checkAnswer() {
            signature_attempts += 1;
            const question = questions[currentQuestion];
            const feedback = document.getElementById('feedback');
            let allCorrect = true;
            let correctAnswer = question.signature;

            Object.keys(question.answers).forEach(function(key) {
                const dropdown = document.getElementById(key);
                const userAnswer = dropdown.value;
                const correctValue = question.answers[key];

                if (userAnswer === correctValue) {
                    dropdown.classList.add('is-valid');
                    dropdown.classList.remove('is-invalid');
                } else {
                    dropdown.classList.add('is-invalid');
                    dropdown.classList.remove('is-valid');
                    allCorrect = false;
                }

                correctAnswer = correctAnswer.replace('___' + key + '___', correctValue);
            });

            if (allCorrect) {
                feedback.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle-fill"></i> Correct signature!</div>';

                completedQuestions.add(currentQuestion);
                createNavbar();
                if (document.getElementById('code-section')) {
                    document.getElementById('code-section').style.display = 'block';
                }
                document.getElementById('next-btn').disabled = false;
            } else if (signature_attempts >= 3) {
                feedback.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle-fill"></i> Not quite. The correct answer is:<br><code>' + correctAnswer + '</code></div>';
                if (document.getElementById('code-section')) {
                    document.getElementById('code-section').style.display = 'block';
                }
                document.getElementById('next-btn').disabled = false;
            } else {
                feedback.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle-fill"></i> Not quite. Try again!</div>';
                document.getElementById('next-btn').disabled = true;
            }
        }

        async function checkCode() {
            const codeInput = document.getElementById('code-input').value;
            const question = questions[currentQuestion];
            const loading = document.getElementById('loading');
            const codeFeedback = document.getElementById('code-feedback');

            loading.style.display = 'inline';
            codeFeedback.innerHTML = '';

            const prompt = "You are a Java programming instructor. Evaluate this student's code.\n\n" +
                "Task: " + question.description.replace(/<\/?code>/g, '') + "\n\n" +
                "Student's code:\n" + codeInput + "\n\n" +
                "Evaluate if the code:\n" +
                "1. Has the correct method signature\n" +
                "2. Implements the logic correctly\n" +
                "3. Would compile and run properly\n\n" +
                "Please do NOT make suggestions to:\n" +
                "1. Add comments\n" +
                "2. Check for null arguments or null pointers\n" +
                "3. Add any functionality beyond a standard AP CS curriculum understanding of basic Java\n" +
                "YOU MUST RESPOND WITH ONLY VALID JSON. NO MARKDOWN. NO CODE BLOCKS.\n\n" +
                "{\n" +
                '  "correct": true,\n' +
                '  "feedback": "Brief explanation",\n' +
                '  "suggestions": "Tips or empty string. Format as an html unordered list. One tip per item. Do not include java code."\n' +
                "}";

            const apiUrl = 'https://llm-router.emailpatrick74.workers.dev';

            const requestBody = {
                messages: [
                    { role: "system", content: "You are a helpful Java programming instructor. Always respond with valid JSON only." },
                    { role: "user", content: prompt }
                ],
                model: "gpt-4o-mini",
                temperature: 0.3,
                max_tokens: 500,
                top_p: 0.8
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'API request failed');

                let resultText = data.choices[0].message.content;
                resultText = resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                if (jsonMatch) resultText = jsonMatch[0];

                let result = JSON.parse(resultText);

                loading.style.display = 'none';
                const alertClass = result.correct ? 'alert-success' : 'alert-warning';
                const icon = result.correct ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
                codeFeedback.innerHTML = '<div class="alert ' + alertClass + '"><i class="bi ' + icon + '"></i> <strong>' +
                    (result.correct ? 'Great job!' : 'Not quite there yet') + '</strong><br>' +
                    result.feedback +
                    (result.suggestions ? '<br><br><strong>Suggestions:</strong> ' + result.suggestions : '') +
                    '</div>';
                if (result.correct) {
                    score++;
                    updateScoreDisplay();
                }
            } catch (error) {
                loading.style.display = 'none';
                codeFeedback.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-circle-fill"></i> Error: ' + error.message + '</div>';
            }
        }

        function nextQuestion() {
            currentQuestion++;
            if (currentQuestion < questions.length) {
                displayQuestion();
                createNavbar();
            } else {
                showFinalScore();
            }
        }

        function showFinalScore() {
            const content = document.getElementById('quiz-content');
            const progress = document.getElementById('progress');
            const percentage = Math.round((score / questions.length) * 100);

            progress.textContent = 'Quiz Complete!';

            content.innerHTML = '<div class="text-center py-5">' +
                '<i class="bi bi-trophy-fill text-warning" style="font-size: 5rem;"></i>' +
                '<h2 class="mt-4">Final Score</h2>' +
                '<p class="display-1 my-4">' + score + '/' + questions.length + '</p>' +
                '<p class="lead text-muted">' + percentage + '%</p>' +
                '<button class="btn btn-lg btn-primary mt-3" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Restart Quiz</button>' +
                '</div>';
        }

        // Initialize
        createNavbar();
        displayQuestion();
        updateScoreDisplay();
    </script>
</body>
</html>